# Development Setup

Assumptions will be made regarding package managers and setup. Conform.
Supporting:

- Debian based Linux distros
- MacOS M1 and Intel

## Pre-reqs

Before we get to app setup and running. You will need these:

- os base packages (varies by OS)
- Docker
- pyenv
- python
- poetry
- nvm
- node
- yarn

### Linux setup

```bash
# Install base packages
apt-get update
apt-get install -y locales make build-essential libssl-dev zlib1g-dev \
    libbz2-dev libreadline-dev libsqlite3-dev wget curl zip llvm libncurses5-dev \
    libncursesw5-dev xz-utils tk-dev libffi-dev liblzma-dev git \
    neovim htop lsof sudo software-properties-common poppler-utils gcc \
    gfortran libblas-dev liblapack-dev \
    g++ protobuf-compiler libprotobuf-dev libmagic1 antiword tesseract-ocr

# Install Docker
curl -fsSL https://get.docker.com | sudo sh

# Install PyEnv and Python
curl -fsSL https://pyenv.run | bash
echo "export PATH=\"\$HOME/.pyenv/bin:\$HOME/.pyenv/shims:\$HOME/.local/bin:\$PATH\"" >> ~/.bashrc
export PATH="$HOME/.pyenv/bin:$HOME/.pyenv/shims:$HOME/.local/bin:$PATH"
pyenv install 3.10.3
pyenv global 3.10.3

# Install Poetry
curl -sSL https://install.python-poetry.org | python3

# Install NVM and Node/Yarn
curl -fsSL https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.1/install.sh | bash
source ~/.nvm/nvm.sh
nvm install node 18
npm install yarn -g
```

### MacOS setup

```sh

# Install base packages

xcode-select --install

# brew is apt more or less
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

brew install gnupg coreutils awscli protobuf libmagic swig xpdf imagemagick@6 antiword tesseract

# Install Docker
brew install docker
brew install --cask docker
curl -fsSL https://get.docker.com | sudo sh
# Install and run docker desktop: https://www.docker.com/products/docker-desktop/

# Install PyEnv and Python
brew install pyenv
# If you are using latest version of osx run this command: touch ~/.zshrc
source ~/.zshrc
pyenv install 3.10.3
pyenv global 3.10.3

# Add pyenv path to ~/.zshrc (unless it is already there):
export PYENV_ROOT="$HOME/.pyenv"
export PATH="$PYENV_ROOT/bin:$PATH"
export PATH="$HOME/.pyenv/bin:$HOME/.pyenv/shims:$HOME/.local/bin:$PATH"

# Install Poetry

curl -sSL https://install.python-poetry.org | python3

# Install NVM and Node/Yarn

curl -fsSL https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.1/install.sh | bash
source ~/.zshrc
nvm install node 18
npm install yarn -g

```

## Application Setup

### Create and Clone Repo

## Get your autogenerated repo username and password

- Visit <https://mmitdev.visualstudio.com/Apollo/_git/Apollo>
- Click on clone
- Click on Generate Git Credentials and copy password

## Open Command Prompt in directory where you want to install the project

```bash
git clone https://mmitdev.visualstudio.com/Apollo/_git/Apollo
cd Apollo
```

### Create Virtual Env

```bash
python -m venv .venv
source .venv/bin/activate
```

### Initial Setup Frontend

```bash
cd frontend
# yarn install node deps
yarn install
yarn build
```

### Initial Setup Backend

```bash
source .venv/bin/activate

export GRPC_PYTHON_BUILD_SYSTEM_OPENSSL=1
export GRPC_PYTHON_BUILD_SYSTEM_ZLIB=1

# poetry install python deps
PIP_CONSTRAINT=build-constraints.txt CFLAGS="-mavx -DWARN(a)=(a) -I /opt/homebrew/opt/protobuf/include" \
    LDFLAGS="-L/opt/homebrew/opt/protobuf/lib" \
    poetry install

# setup precommit hooks
poetry run pre-commit install
playwright install chromium
playwright install-deps

```

### RxNorm Therapy Tagging Setup

To run therapy tagging locally, you must populate S3 with the rxNorm files. Since rxNorm files are large, we do not want to request from S3 for every run. Use minio to access large files locally with an S3 compatiable api.

```bash
brew install minio
```

- Download https://www.dropbox.com/s/w5vo6dpxb4v4sn1/latest.zip?dl=1 and unzip
- Drag 'latest' folder into source-hub/models/ prefix in Minio UI at http://localhost:9000 (username: admin, password: adminadmin)
- If models folder does not exist, click 'Create new path' icon in Minio UI
- Restart scrapeworker, run collection, get tags

## Running the services

Each service should run in it's own terminal. Use your editors built in terminal management for pane splitting or a tool like tmux.

```bash
# Before starting, make sure:
# - You are in the Apollo folder
# - Docker Desktop is open

# Start Local Mongo/Minio/Redis
cd Apollo
docker compose -f ./Docker/docker-compose-dev.yaml up

# Webserver
source .venv/bin/activate
python backend/app/main.py

# Scrape Worker
source .venv/bin/activate
python backend/scrapeworker/main.py

# Parse Worker
source .venv/bin/activate
python backend/parseworker/main.py

# Scheduler Worker
source .venv/bin/activate
python backend/scheduler/main.py

# Async Task Worker
source .venv/bin/activate
python backend/taskworker/main.py

# Frontend
cd frontend
yarn start
```

## Now what?

If everything has gone well, go to <http://localhost:3000> and you should be redirected to our Auth0 SSO login page. Upon login you should see the Sourcehub app.

If that succeeds, try creating a site. I recommend Molina HealthCare OH Drug at <https://www.molinahealthcare.com/providers/oh/duals/drug/formulary.aspx>. Once created, go into it and click the 'Run Collection' button and hope for the best, watching the logs for activity/errors.

## Common Issues

### Issues with python version

**Problem:** If you're running into errors about your python version not matching the expected and `pyenv global VERSON` is not correcting it

Check which version of python you are using `python --version` and where it's pulling that version from `which python` from there you might need to update the symlink to `python` (remove the old link and create a new one).

You will need to redo your environment after this

### Local Redirect on Startup

**Problem:** When starting the frontend project your browser redirects to `https://undefined/authorize?redirect_uri=xxxx`.

To address this, ensure the backend is running. If it is and this still occurs, you may need to remove a line from your `~/etc/hosts` file. Open the file and comment out the line `::1 localhost`.

Your file should look something like this after doing so.

```
##
# Host Database
#
# localhost is used to configure the loopback interface
# when the system is booting.  Do not change this entry.
##
127.0.0.1    localhost
255.255.255.255    broadcasthost
#::1             localhost
# Added by Docker Desktop
# To allow the same kube context to work on the host and the container:
127.0.0.1 kubernetes.docker.internal
# End of section
```

After saving the file and restarting the app, this should fix this issue.

If you are on mac and can't see `~/etc/hosts` run the following commands `defaults write com.apple.Finder AppleShowAllFiles true` [Press Return] `killall Finder`

### Issues with request access

**Problem:** If you keep getting redirected to http://localhost:3000/request-access

Add yourself to your local mongodb instance.

Go to source-hub.Users then add data and insert document:

```
{
    "\_id": {
    "$oid": "AUTO GENERATE"
    },
    "email": "USERMANE@mmitnetwork.com",
    "full_name": "FULL NAME",
    "roles": [],
    "is_admin": true,
    "disabled": false,
    "hashed_password": ""
}
```

### Access to Local Mongo and Minio

Connect to your local mongo using the following info:

- URI: mongodb://localhost:27017
- Username: admin
- Password: admin

Access minio console:

- Go to localhost:9001
- Username: admin
- Password: adminadmin

## Testing

### Frontend Tests

```bash
cd frontend
yarn test
```

### Backend Tests

```bash
# In virtual env
python -m pytest
```

### Windows Install

## Installers

- Install node using Installer from <https://nodejs.org/en/download/>. This should install npm
- Install Docker Desktop from <https://docs.docker.com/desktop/windows/install/>. The same Install will be used in WSL environment
- Install 10.3.4 Python for Windows from <https://www.python.org/downloads/>. If you have any other older version installed, make sure that 10.3.4 becomes the default version. Check version by running 'python --version' command. This might require changing PATH environment variable
- Install Visual Studio Code
- Install Git

```bash
# Install Yarn
npm install yarn -g

# Install Poetry
pip install poetry


# Build Frontend
## Last step will generate 'build' directory inside 'frontend' directory, which is required to run server code
cd frontend
yarn install
yarn build
yarn run build

# Create Virtual Env and activate it
## Before you do this step, check again that python version is 3.10.4.  Make sure that you are in 'Apollo' directory
cd ..
python -m venv .venv
call .venv\Scripts\activate.bat


# Build Backend
cd backend
poetry install && playwright install chromium && playwright install-deps
```

### Starting Services

Each service should run in it's own terminal. Use your editors built in terminal management for pane splitting or a tool like tmux.

```bash
# Before starting, make sure:
# - You are in the Apollo folder
# - Docker Desktop is open

# Start Local Mongo/Minio/Redis
docker compose -f ./Docker/docker-compose-dev.yaml up

# Webserver
python backend/app/main.py

# Scrape Worker
python backend/scrapeworker/main.py

# Parse Worker
python backend/parseworker/main.py

# Parse Worker
python backend/scheduler/main.py

# Async Task Workers
# used with PDF Diffing and Lineage Reprocessing
python backend/taskworker/main.py

# Frontend
cd frontend
yarn start
```

## WSL2

In case we run into problems running system on Windows, we checked an option running using WSL2
Follow instructions in <https://code.visualstudio.com/docs/remote/wsl-tutorial> up to 'Python development' section
Follow <https://docs.microsoft.com/en-us/windows/wsl/tutorials/wsl-containers> to run Docker containers. You will be running all docker containers from Windows terminal
Then follow above WSL2 instructions to install all required components. You might need to add 'sudo' to some commands.
Note: I was able to clone git repository only using HTTPS command from Windows instructions. I was not able to start VS Code from WSL terminal.
Instead I started VS Code on Windows, used 'Remote WSL' extension to switch to Ubuntu and then selected Ubuntu directory where project was installed
Confirm that python version is 3.10.4 before you generate virtual environment
At some point I had a problem with PATH. It was fixed by manually updating .bashrc file. PATH definition at the end of the file had single instead of double quotes. We believe it was caused by some incorrect Export PATH command that is no longer part of this file
